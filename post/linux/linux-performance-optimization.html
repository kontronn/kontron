<!DOCTYPE html>
<html lang="zh-CN">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)" />
<meta name="generator" content="Hugo 0.92.2" />
<link rel="shortcut icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/imgs/icons/favicon_16x16_next.png">
<link rel="icon" type="image/png" sizes="32x32" href="/imgs/icons/favicon_32_32_next.png">
<link rel="apple-touch-icon" sizes="180x180" href="/imgs/icons/apple_touch_icon_next.png">
<meta itemprop="name" content="Linux性能优化" />
<meta itemprop="description" content="Linux性能优化" />
<meta itemprop="datePublished" ZgotmplZ />
<meta itemprop="dateModified" ZgotmplZ />
<meta itemprop="image" content="https://www.kontronn.com/imgs/VxWorks_7_logo.png" />
<meta itemprop="keywords" content="linux,performance" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Linux性能优化" />
<meta property="og:description" content="Linux性能优化" />
<meta property="og:image" content="/imgs/VxWorks_7_logo.png" />
<meta property="og:image:width" content="312" />
<meta property="og:image:height" content="312" />
<meta property="og:image:type" content="image/jpeg/png/svg/jpg" />
<meta property="og:url" content="https://www.kontronn.com/post/linux/linux-performance-optimization.html"/>
<meta property="og:site_name" content="Kontronn" />
<meta property="og:locale" content="zh-CN"/>
<meta property="article:author" content="VxWorks OS" />
<meta property="article:published_time" content="2023-07-23 12:00:28 -0400 -0400" />
<meta property="article:modified_time" content="2023-07-23 12:00:28 -0400 -0400" />


  
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.1.2/css/all.min.css" />
  
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" />


<link rel="stylesheet" href="/css/main.min.7d561ec9984cf0cb727fc88e14a92134576c99ccb9ce2f31b5b5541ab4ced328.css">
  <style type="text/css">
    .post-footer, .flinks-list-footer hr:after {
      content: "~ 我可是有底线的哟 ~";
    }
  </style>
  <script class="next-config" data-name="page" type="application/json">{"comments":false,"isHome":false,"isPage":true,"path":"linux-performance-optimization.html","permalink":"https://www.kontronn.com/post/linux/linux-performance-optimization.html","title":"Linux性能优化"}</script>
  <script type="text/javascript">
  document.addEventListener('DOMContentLoaded', () => {
    var script = document.createElement('script');
      
    script.charset = "UTF-8";
    script.src     = "https:\/\/busuanzi.ibruce.info\/busuanzi\/2.3\/busuanzi.pure.mini.js";
    script.async   = "true"

    document.head.appendChild(script);
  });
</script>




  <title>Linux性能优化 - Kontronn</title>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage"  class="use-motion" >
  <div class="headband"></div>
  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
<div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Kontronn</h1>
      <i class="logo-line"></i>
    </a>
    
      <p class="site-subtitle" itemprop="description">Embedded World</p>
      <img class="custom-logo-image" src="/imgs/VxWorks_7_logo.png" alt="Kontronn">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
      
      <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>

<nav class="site-nav">
  <ul class="main-menu menu">
    <li class="menu-item menu-item-home">
      <a href="/" class="hvr-icon-pulse " rel="section"><i class="fa fa-home hvr-icon"></i>首页
      </a>
    </li>
    <li class="menu-item menu-item-about">
      <a href="/about.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-user hvr-icon"></i>关于
      </a>
    </li>
    <li class="menu-item menu-item-flinks">
      <a href="/flinks.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-thumbs-up hvr-icon"></i>友情链接
      </a>
    </li>
    <li class="menu-item menu-item-archives">
      <a href="/archives/" class="hvr-icon-pulse " rel="section"><i class="fa fa-archive hvr-icon"></i>归档
        <span class="badge">266</span>
      </a>
    </li>
    <li class="menu-item menu-item-commonweal">
      <a href="https://www.vxworks.net" class="hvr-icon-pulse " rel="section"><i class="fa fa-heartbeat hvr-icon"></i>赞助商
      </a>
    </li>
    <li class="menu-item menu-item-search">
      <a role="button" class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索
      </a>
    </li>
  </ul>
</nav>

  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

      </div>
      <div class="toggle sidebar-toggle" role="button">
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
</div>
<aside class="sidebar">
  
  <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
    <ul class="sidebar-nav">
      <li class="sidebar-nav-toc">
        文章目录
      </li>
      <li class="sidebar-nav-overview">
        站点概览
      </li>
    </ul>
    <div class="sidebar-panel-container">
      
      <div class="post-toc-wrap sidebar-panel">
        <div class="post-toc animated"><nav id="TableOfContents">
  <ul>
    <li><a href="#性能优化">性能优化</a>
      <ul>
        <li><a href="#性能指标">性能指标</a></li>
        <li><a href="#到底应该怎么理解平均负载">到底应该怎么理解“平均负载”</a></li>
        <li><a href="#平均负载多少时合理">平均负载多少时合理</a></li>
      </ul>
    </li>
    <li><a href="#cpu">CPU</a>
      <ul>
        <li><a href="#cpu上下文切换上">CPU上下文切换(上)</a>
          <ul>
            <li><a href="#进程上下文切换">进程上下文切换</a></li>
            <li><a href="#线程上下文切换">线程上下文切换</a></li>
            <li><a href="#中断上下文切换">中断上下文切换</a></li>
          </ul>
        </li>
        <li><a href="#cpu上下文切换下">CPU上下文切换(下)</a></li>
        <li><a href="#某个应用的cpu使用率达到100怎么办">某个应用的CPU使用率达到100%，怎么办？</a></li>
        <li><a href="#系统的cpu使用率很高为什么找不到高cpu的应用">系统的CPU使用率很高，为什么找不到高CPU的应用？</a></li>
        <li><a href="#系统中出现大量不可中断进程和僵尸进程怎么办">系统中出现大量不可中断进程和僵尸进程怎么办？</a>
          <ul>
            <li><a href="#进程状态">进程状态</a></li>
            <li><a href="#磁盘o_direct问题">磁盘O_DIRECT问题</a></li>
            <li><a href="#僵尸进程">僵尸进程</a></li>
          </ul>
        </li>
        <li><a href="#cpu性能指标">CPU性能指标</a></li>
        <li><a href="#性能工具">性能工具</a></li>
        <li><a href="#cpu优化">CPU优化</a></li>
      </ul>
    </li>
    <li><a href="#内存">内存</a>
      <ul>
        <li><a href="#linux内存是怎么工作的">Linux内存是怎么工作的</a>
          <ul>
            <li><a href="#内存映射">内存映射</a></li>
            <li><a href="#虚拟内存空间分布">虚拟内存空间分布</a></li>
            <li><a href="#内存分配与回收">内存分配与回收</a></li>
            <li><a href="#如何查看内存使用情况">如何查看内存使用情况</a></li>
          </ul>
        </li>
        <li><a href="#怎样理解内存中的buffer和cache">怎样理解内存中的Buffer和Cache？</a></li>
        <li><a href="#如何利用系统缓存优化程序的运行效率">如何利用系统缓存优化程序的运行效率</a>
          <ul>
            <li><a href="#缓存命中率">缓存命中率</a></li>
            <li><a href="#dd缓存加速">dd缓存加速</a></li>
            <li><a href="#o_direct选项绕过系统缓存">O_DIRECT选项绕过系统缓存</a></li>
          </ul>
        </li>
        <li><a href="#内存泄漏如何定位和处理">内存泄漏，如何定位和处理？</a>
          <ul>
            <li><a href="#内存的分配与回收">内存的分配与回收</a></li>
            <li><a href="#如何检测内存泄漏">如何检测内存泄漏</a></li>
          </ul>
        </li>
        <li><a href="#为什么系统的swap变高">为什么系统的Swap变高</a>
          <ul>
            <li><a href="#swap原理">Swap原理</a></li>
            <li><a href="#numa-与-swap">NUMA 与 SWAP</a></li>
            <li><a href="#swappiness">swappiness</a></li>
            <li><a href="#swap升高时如何定位分析">Swap升高时如何定位分析</a></li>
          </ul>
        </li>
        <li><a href="#如何快准狠找到系统内存存在的问题">如何“快准狠”找到系统内存存在的问题</a>
          <ul>
            <li><a href="#内存性能指标">内存性能指标</a></li>
            <li><a href="#内存性能工具">内存性能工具</a></li>
            <li><a href="#如何迅速分析内存的性能瓶颈">如何迅速分析内存的性能瓶颈</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div>
      
      <div class="site-overview-wrap sidebar-panel">
<div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="VxWorks OS"
      src="/imgs/hugo_next_avatar.png">
  <p class="site-author-name" itemprop="name">VxWorks OS</p>
  <div class="site-description" itemprop="description">Where there is embedded, there is VxWorks.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
    <div class="site-state-item site-state-posts">
      <a href="/archives/">
        <span class="site-state-item-count">266</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">
      <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span>
      </a>
    </div>
    <div class="site-state-item site-state-tags">
      <a href="/tags/">
        <span class="site-state-item-count">353</span>
        <span class="site-state-item-name">标签</span>
      </a>
    </div>
  </nav>
</div>
<div class="links-of-social site-overview-item animated">


  <span class="links-of-social-item">
    <a href="https://github.com/" title="Github → https://github.com/" rel="noopener" class="hvr-icon-pulse" target="_blank">
      <i class="fab fa-github fa-fw  hvr-icon "></i>Github
    </a>
  </span>
  <span class="links-of-social-item">
    <a href="https://www.zhihu.com/" title="知乎 → https://www.zhihu.com/" rel="noopener" class="hvr-icon-pulse" target="_blank">
      <i class="fa fa-book fa-fw  hvr-icon "></i>知乎
    </a>
  </span>
</div>
<div class="cc-license animated" itemprop="license">
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank" title="共享知识">
    <img src="/imgs/cc/small/by_nc_sa.svg" alt="共享知识">
  </a>
</div>
<div class="links-of-blogroll site-overview-item animated">
  <div class="links-of-blogroll-title">
    <i class="fa fa-globe fa-fw"></i>友情链接
  </div>
  <ul class="links-of-blogroll-list">
    <li class="links-of-blogroll-item">
      <a href="https://www.gaitpu.com" title="https://www.gaitpu.com" target="_blank">Google AI TPU</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://www.vxworks.net" title="https://www.vxworks.net" target="_blank">VxWorks俱乐部</a>
    </li>
  </ul>
</div>
      </div>
    </div>
   
  </div>
<div class="sidebar-card-widget">
  <div class="item-headline">
    <i class="fas fa-chart-line"></i>
    <span>网站资讯</span>
  </div>
  <div class="siteinfo">
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa-solid fa-calendar-check"></i>已运行：</div>
      <div class="item-count" id="runTimes" data-publishdate="2022-01-20T05:40:25-04:00"></div>
    </div>
      <div class="siteinfo-item">
        <div class="item-name">
          <i class="fas fa fa-user"></i>总访客数：
        </div>
        <div class="item-count" id="busuanzi_value_site_uv"></div>
      </div>
      <div class="siteinfo-item">
        <div class="item-name">
          <i class="fas fa fa-eye"></i>页面浏览：
        </div>
        <div class="item-count" id="busuanzi_value_site_pv"></div>
      </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-font"></i>总字数：</div>
      <div class="item-count" id="wordsCount" data-count="50106"></div>
    </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-mug-hot"></i>阅读约：</div>
      <div class="item-count" id="readTimes" data-times="407"></div>
    </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-clock-rotate-left"></i>最后更新于：</div>
      <div class="item-count" id="last-push-date" data-lastpushdate="2024-08-28T22:24:32&#43;08:00"></div>
    </div>
  </div>
</div>
</aside>
<div class="sidebar-dimmer"></div>

    </header>
    
    <div class="tool-buttons" >
  <a id="goto-comments" class="button goto-comments" href="#comments"  title="直达评论">
    <i class="fas fa-comments"></i>
  </a> 
  <div id="switch-theme" class="button" title="深浅模式切换">
    <i class="fas fa-adjust"></i>
  </div> 
  
  <div class="back-to-top" role="button" title="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div> 
</div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
    <div class="main-inner post posts-expand">
      
  <div class="post-block">
  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.kontronn.com/post/linux/linux-performance-optimization.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/imgs/hugo_next_avatar.png">
      <meta itemprop="name" content="VxWorks OS">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VxWorks OS">
      <meta itemprop="description" content="Where there is embedded, there is VxWorks.">
    </span>
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux性能优化">
      <meta itemprop="description" content="Linux性能优化">
    </span>
    <header class="post-header">
       <h1 class="post-title" itemprop="name headline">Linux性能优化 </h1> <div class="post-meta-container">
  <div class="post-meta-items">
    


<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-calendar"></i>
  </span>
  <span class="post-meta-item-text">发表于：</span>
  <time title="发表于：2023-07-23 12:00:28 -0400 -0400" itemprop="dateCreated datePublished" datetime="2023-07-23 12:00:28 -0400 -0400">2023-07-23</time>
</span>
    
    
<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-folder-open"></i>
  </span>
  <span class="post-meta-item-text">分类于：</span>
  <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
    <a href="/categories/linux" itemprop="url" rel="index">
      <span itemprop="name">Linux</span>
    </a>
  </span>
</span>
  </div>
  <div class="post-meta-items">
    
<span class="post-meta-item" title="字数">
  <span class="post-meta-item-icon">
    <i class="far fa-file-word"></i>
  </span>
  <span class="post-meta-item-text">字数：</span><span>1818</span>
</span>
    
<span class="post-meta-item" title="阅读">
  <span class="post-meta-item-icon">
    <i class="far fa-clock"></i>
  </span>
  <span class="post-meta-item-text">阅读：&asymp;</span>
  <span>9分钟</span>
</span>

    
<span class="post-meta-item" title="浏览">
  <span class="post-meta-item-icon">
    <i class="far fa-eye"></i>
  </span>
  <span class="post-meta-item-text">
  浏览：
  </span>
  <span id="busuanzi_value_page_pv" data-path="/post/linux/linux-performance-optimization.html"><i class="fa fa-sync fa-spin"></i></span>
</span>

  </div>
  
</div>


    </header>
    
    <div class="post-body  autonumber " itemprop="articleBody">
      
  <p>本文详细讲解了Linux性能优化的全景</p>
<h1 id="linux性能优化">Linux性能优化</h1>
<h2 id="性能优化">性能优化</h2>
<h3 id="性能指标">性能指标</h3>
<p>高并发和响应快对应着性能优化的两个核心指标：<strong>吞吐</strong>和<strong>延时</strong></p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-1.png" alt="高并发和响应快"></p>
<ul>
<li><strong>应用负载</strong>角度：直接影响了产品终端的用户体验</li>
<li><strong>系统资源</strong>角度：资源使用率、饱和度等</li>
</ul>
<p><strong>性能问题的本质</strong>就是系统资源已经到达瓶颈，但请求的处理还不够快，无法支撑更多的请求。 性能分析实际上就是找出应用或系统的瓶颈，设法去避免或缓解它们。</p>
<ul>
<li>选择指标评估应用程序和系统性能</li>
<li>为应用程序和系统设置性能目标</li>
<li>进行性能基准测试</li>
<li>性能分析定位瓶颈</li>
<li>性能监控和告警</li>
</ul>
<p>对于不同的性能问题要选取不同的性能分析工具。 下面是常用的Linux Performance Tools以及对应分析的性能问题类型。</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-2.png" alt="Linux Performance Tools"></p>
<h3 id="到底应该怎么理解平均负载">到底应该怎么理解“平均负载”</h3>
<p>**平均负载：**单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数。它和我们传统意义上理解的CPU使用率并没有直接关系。</p>
<p>其中不可中断进程是正处于内核态关键流程中的进程（如常见的等待设备的I/O响应）。<strong>不可中断状态实际上是系统对进程和硬件设备的一种保护机制。</strong></p>
<h3 id="平均负载多少时合理">平均负载多少时合理</h3>
<p>实际生产环境中将系统的平均负载监控起来，根据历史数据判断负载的变化趋势。当负载存在明显升高趋势时，及时进行分析和调查。 当然也可以当设置阈值（如当平均负载高于CPU数量的70%时）</p>
<p>现实工作中我们会经常混淆平均负载和CPU使用率的概念，其实两者并不完全对等：</p>
<ul>
<li>CPU密集型进程，大量CPU使用会导致平均负载升高，此时两者一致</li>
<li>I/O密集型进程，等待I/O也会导致平均负载升高，此时CPU使用率并不一定高</li>
<li>大量等待CPU的进程调度会导致平均负载升高，此时CPU使用率也会比较高</li>
</ul>
<p><strong>平均负载高时可能是CPU密集型进程导致，也可能是I/O繁忙导致。具体分析时可以结合mpstat/pidstat工具辅助分析负载来源</strong></p>
<h2 id="cpu">CPU</h2>
<h3 id="cpu上下文切换上">CPU上下文切换(上)</h3>
<p><strong>CPU上下文切换</strong>，就是把前一个任务的CPU上下文（CPU寄存器和PC）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的位置，运行新任务。其中，保存下来的上下文会存储在系统内核中，待任务重新调度执行时再加载，保证原来的任务状态不受影响。</p>
<p>按照任务类型，CPU上下文切换分为：</p>
<ul>
<li>进程上下文切换</li>
<li>线程上下文切换</li>
<li>中断上下文切换</li>
</ul>
<h4 id="进程上下文切换">进程上下文切换</h4>
<p>Linux进程按照等级权限将进程的运行空间分为内核空间和用户空间。从用户态向内核态转变时需要通过系统调用来完成。</p>
<p>一次系统调用过程其实进行了两次CPU上下文切换：</p>
<ul>
<li>CPU寄存器中用户态的指令位置先保存起来，CPU寄存器更新为内核态指令的位置，跳转到内核态运行内核任务；</li>
<li>系统调用结束后，CPU寄存器恢复原来保存的用户态数据，再切换到用户空间继续运行。</li>
</ul>
<p>系统调用过程中并不会涉及虚拟内存等进程用户态资源，也不会切换进程。和传统意义上的进程上下文切换不同。因此<strong>系统调用通常称为特权模式切换</strong>。</p>
<p>进程是由内核管理和调度的，进程上下文切换只能发生在内核态。 因此相比系统调用来说，在保存当前进程的内核状态和CPU寄存器之前，需要先把该进程的虚拟内存，栈保存下来。再加载新进程的内核态后，还要刷新进程的虚拟内存和用户栈。</p>
<p>进程只有在调度到CPU上运行时才需要切换上下文，有以下几种场景： CPU时间片轮流分配，系统资源不足导致进程挂起，进程通过sleep函数主动挂起，高优先级进程抢占时间片，硬件中断时CPU上的进程被挂起转而执行内核中的中断服务。</p>
<h4 id="线程上下文切换">线程上下文切换</h4>
<p>线程上下文切换分为两种：</p>
<ul>
<li>前后线程同属于一个进程，切换时虚拟内存资源不变，只需要切换线程的私有数据，寄存器等；</li>
<li>前后线程属于不同进程，与进程上下文切换相同。</li>
</ul>
<p>同进程的线程切换消耗资源较少，这也是多线程的优势。</p>
<h4 id="中断上下文切换">中断上下文切换</h4>
<p>中断上下文切换并不涉及到进程的用户态，因此中断上下文只包括内核态中断服务程序执行所必须的状态（CPU寄存器，内核堆栈，硬件中断参数等）。</p>
<p><strong>中断处理优先级比进程高，所以中断上下文切换和进程上下文切换不会同时发生</strong></p>
<h3 id="cpu上下文切换下">CPU上下文切换(下)</h3>
<p>通过vmstat可以查看系统总体的上下文切换情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">vmstat <span style="color:#ae81ff">5</span>         <span style="color:#75715e">#每隔5s输出一组数据</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511056</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">18</span>    <span style="color:#ae81ff">60</span>    <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">96</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">450</span> <span style="color:#ae81ff">1176</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">99</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">429</span> <span style="color:#ae81ff">1135</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">431</span> <span style="color:#ae81ff">1132</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">467</span> <span style="color:#ae81ff">1195</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103388</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">426</span> <span style="color:#ae81ff">1139</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">99</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">95184</span> <span style="color:#ae81ff">145412</span> <span style="color:#ae81ff">511108</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">1228</span>  <span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">94</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">103512</span> <span style="color:#ae81ff">145416</span> <span style="color:#ae81ff">511076</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">455</span>  <span style="color:#ae81ff">723</span> <span style="color:#ae81ff">1573</span> <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">83</span>  <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0</span>
</code></pre></div><ul>
<li>cs （context switch） 每秒上下文切换次数</li>
<li>in （interrupt） 每秒中断次数</li>
<li>r （runnning or runnable）就绪队列的长度，正在运行和等待CPU的进程数</li>
<li>b （Blocked） 处于不可中断睡眠状态的进程数</li>
</ul>
<p>要查看每个进程的详细情况，需要使用pidstat来查看每个进程上下文切换情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">pidstat -w <span style="color:#ae81ff">5</span>
14时51分16秒   UID       PID   cswch/s nvcswch/s  Command
14时51分21秒     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">1</span>      0.80      0.00  systemd
14时51分21秒     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">6</span>      1.40      0.00  ksoftirqd/0
14时51分21秒     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">9</span>     32.67      0.00  rcu_sched
14时51分21秒     <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">11</span>      0.40      0.00  watchdog/0
14时51分21秒     <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">32</span>      0.20      0.00  khugepaged
14时51分21秒     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">271</span>      0.20      0.00  jbd2/vda1-8
14时51分21秒     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">1332</span>      0.20      0.00  argusagent
14时51分21秒     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">5265</span>     10.02      0.00  AliSecGuard
14时51分21秒     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">7439</span>      7.82      0.00  kworker/0:2
14时51分21秒     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">7906</span>      0.20      0.00  pidstat
14时51分21秒     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">8346</span>      0.20      0.00  sshd
14时51分21秒     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">20654</span>      9.82      0.00  AliYunDun
14时51分21秒     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">25766</span>      0.20      0.00  kworker/u2:1
14时51分21秒     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">28603</span>      1.00      0.00  python3
</code></pre></div><ul>
<li>cswch 每秒自愿上下文切换次数 （进程无法获取所需资源导致的上下文切换）</li>
<li>nvcswch 每秒非自愿上下文切换次数 （时间片轮流等系统强制调度）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">vmstat <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e">#首先获取空闲系统的上下文切换次数</span>
sysbench --threads<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> --max-time<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span> threads run <span style="color:#75715e">#模拟多线程切换问题</span>

vmstat <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e">#新终端观察上下文切换情况</span>
此时发现cs数据明显升高，同时观察其他指标：
r列： 远超系统CPU个数，说明存在大量CPU竞争
us和sy列： sy列占比80%，说明CPU主要被内核占用
in列： 中断次数明显上升，说明中断处理也是潜在问题
</code></pre></div><p>说明运行/等待CPU的进程过多，导致大量的上下文切换，上下文切换导致系统的CPU占用率高</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">pidstat -w -u <span style="color:#ae81ff">1</span>  <span style="color:#75715e">#查看到底哪个进程导致的问题</span>
</code></pre></div><p>从结果中看出是sysbench导致CPU使用率过高，但是pidstat输出的上下文次数加起来也并不多。分析sysbench模拟的是线程的切换，因此需要在pidstat后加-t参数查看线程指标。</p>
<p>另外对于中断次数过多，我们可以通过/proc/interrupts文件读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">watch -d cat /proc/interrupts
</code></pre></div><p>发现次数变化速度最快的是重调度中断（RES），该中断用来唤醒空闲状态的CPU来调度新的任务运行。分析还是因为过多任务的调度问题，和上下文切换分析一致。</p>
<h3 id="某个应用的cpu使用率达到100怎么办">某个应用的CPU使用率达到100%，怎么办？</h3>
<p>Linux作为多任务操作系统，将CPU时间划分为很短的时间片，通过调度器轮流分配给各个任务使用。为了维护CPU时间，Linux通过事先定义的节拍率，触发时间中断，并使用全局变了jiffies记录开机以来的节拍数。时间中断发生一次该值+1.</p>
<p><strong>CPU使用率</strong>，除了空闲时间以外的其他时间占总CPU时间的百分比。可以通过/proc/stat中的数据来计算出CPU使用率。因为/proc/stat时开机以来的节拍数累加值，计算出来的是开机以来的平均CPU使用率，一般意义不大。可以间隔取一段时间的两次值作差来计算该段时间内的平均CPU使用率。 <strong>性能分析工具给出的都是间隔一段时间的平均CPU使用率，要注意间隔时间的设置。</strong></p>
<p>CPU使用率可以通过top 或 ps来查看。分析进程的CPU问题可以通过perf，它以性能事件采样为基础，不仅可以分析系统的各种事件和内核性能，还可以用来分析指定应用程序的性能问题。</p>
<p>perf top / perf record / perf report （-g 开启调用关系的采样）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker run --name nginx -p 10000:80 -itd feisky/nginx
sudo docker run --name phpfpm -itd --network container:nginx feisky/php-fpm

ab -c <span style="color:#ae81ff">10</span> -n <span style="color:#ae81ff">100</span> http://XXX.XXX.XXX.XXX:10000/ <span style="color:#75715e">#测试Nginx服务性能</span>
</code></pre></div><p>发现此时每秒可承受请求给长少，此时将测试的请求数从100增加到10000。 在另外一个终端运行top查看每个CPU的使用率。发现系统中几个php-fpm进程导致CPU使用率骤升。</p>
<p>接着用perf来分析具体是php-fpm中哪个函数导致该问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">perf top -g -p XXXX <span style="color:#75715e">#对某一个php-fpm进程进行分析</span>
</code></pre></div><p>发现其中sqrt和add_function占用CPU过多， 此时查看源码找到原来是sqrt中在发布前没有删除测试代码段，存在一个百万次的循环导致。 将该无用代码删除后发现nginx负载能力明显提升</p>
<h3 id="系统的cpu使用率很高为什么找不到高cpu的应用">系统的CPU使用率很高，为什么找不到高CPU的应用？</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker run --name nginx -p 10000:80 -itd feisky/nginx:sp
sudo docker run --name phpfpm -itd --network container:nginx feisky/php-fpm:sp
ab -c <span style="color:#ae81ff">100</span> -n <span style="color:#ae81ff">1000</span> http://XXX.XXX.XXX.XXX:10000/ <span style="color:#75715e">#并发100个请求测试</span>
</code></pre></div><p>实验结果中每秒请求数依旧不高，我们将并发请求数降为5后，nginx负载能力依旧很低。</p>
<p>此时用top和pidstat发现系统CPU使用率过高，但是并没有发现CPU使用率高的进程。</p>
<p>出现这种情况一般时我们分析时遗漏的什么信息，重新运行top命令并观察一会。发现就绪队列中处于Running状态的进行过多，超过了我们的并发请求次数5. 再仔细查看进程运行数据，发现nginx和php-fpm都处于sleep状态，真正处于运行的却是几个stress进程。</p>
<p>下一步就利用pidstat分析这几个stress进程，发现没有任何输出。用ps aux交叉验证发现依旧不存在该进程。说明不是工具的问题。再top查看发现stress进程的进程号变化了，此时有可能时以下两种原因导致：</p>
<ul>
<li>进程不停的崩溃重启（如段错误/配置错误等），此时进程退出后可能又被监控系统重启；</li>
<li>短时进程导致，即其他应用内部通过exec调用的外面命令，这些命令一般只运行很短时间就结束，很难用top这种间隔较长的工具来发现</li>
</ul>
<p>可以通过pstree来查找 stress的父进程，找出调用关系。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">pstree | grep stress
</code></pre></div><p>发现是php-fpm调用的该子进程，此时去查看源码可以看出每个请求都会调用一个stress命令来模拟I/O压力。 之前top显示的结果是CPU使用率升高，是否真的是由该stress命令导致的，还需要继续分析。 代码中给每个请求加了verbose=1的参数后可以查看stress命令的输出，在中断测试该命令结果显示stress命令运行时存在因权限问题导致的文件创建失败的bug。</p>
<p>此时依旧只是猜测，下一步继续通过perf工具来分析。性能报告显示确实时stress占用了大量的CPU，通过修复权限问题来优化解决即可.</p>
<h3 id="系统中出现大量不可中断进程和僵尸进程怎么办">系统中出现大量不可中断进程和僵尸进程怎么办？</h3>
<h4 id="进程状态">进程状态</h4>
<ul>
<li>R Running/Runnable，表示进程在CPU的就绪队列中，正在运行或者等待运行；</li>
<li>D Disk Sleep，不可中断状态睡眠，一般表示进程正在跟硬件交互，并且交互过程中不允许被其他进程中断；</li>
<li>Z Zombie，僵尸进程，表示进程实际上已经结束，但是父进程还没有回收它的资源；</li>
<li>S Interruptible Sleep，可中断睡眠状态，表示进程因为等待某个事件而被系统挂起，当等待事件发生则会被唤醒并进入R状态；</li>
<li>I Idle，空闲状态，用在不可中断睡眠的内核线程上。 该状态不会导致平均负载升高；</li>
<li>T Stop/Traced，表示进程处于暂停或跟踪状态（SIGSTOP/SIGCONT， GDB调试）；</li>
<li>X Dead，进程已经消亡，不会在top/ps中看到。</li>
</ul>
<p>对于不可中断状态，一般都是在很短时间内结束，可忽略。但是如果系统或硬件发生故障，进程可能会保持不可中断状态很久，甚至系统中出现大量不可中断状态，此时需注意是否出现了I/O性能问题。</p>
<p>僵尸进程一般多进程应用容易遇到，父进程来不及处理子进程状态时子进程就提前退出，此时子进程就变成了僵尸进程。大量的僵尸进程会用尽PID进程号，导致新进程无法建立。</p>
<h4 id="磁盘o_direct问题">磁盘O_DIRECT问题</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker run --privileged --name<span style="color:#f92672">=</span>app -itd feisky/app:iowait
ps aux | grep <span style="color:#e6db74">&#39;/app&#39;</span>
</code></pre></div><p>可以看到此时有多个app进程运行，状态分别时Ss+和D+。其中后面s表示进程是一个会话的领导进程，+号表示前台进程组。</p>
<p>其中<strong>进程组</strong>表示一组相互关联的进程，子进程是父进程所在组的组员。 <strong>会话</strong>指共享同一个控制终端的一个或多个进程组。</p>
<p>用top查看系统资源发现：1）平均负载在逐渐增加，且1分钟内平均负载达到了CPU个数，说明系统可能已经有了性能瓶颈；2）僵尸进程比较多且在不停增加；3）us和sys CPU使用率都不高，iowait却比较高；4）每个进程CPU使用率也不高，但有两个进程处于D状态，可能在等待IO。</p>
<p>分析目前数据可知：iowait过高导致系统平均负载升高，僵尸进程不断增长说明有程序没能正确清理子进程资源。</p>
<p>用dstat来分析，因为它可以同时查看CPU和I/O两种资源的使用情况，便于对比分析。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">dstat <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">10</span>    <span style="color:#75715e">#间隔1秒输出10组数据</span>
</code></pre></div><p>可以看到当wai（iowait）升高时磁盘请求read都会很大，说明iowait的升高和磁盘的读请求有关。接下来分析到底时哪个进程在读磁盘。</p>
<p>之前top查看的处于D状态的进程号，用pidstat -d -p XXX 展示进程的I/O统计数据。发现处于D状态的进程都没有任何读写操作。 在用pidstat -d 查看所有进程的I/O统计数据，看到app进程在进行磁盘读操作，每秒读取32MB的数据。进程访问磁盘必须使用系统调用处于内核态，接下来重点就是找到app进程的系统调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo strace -p XXX <span style="color:#75715e">#对app进程调用进行跟踪</span>
</code></pre></div><p>报错没有权限，因为已经时root权限了。所以遇到这种情况，首先要检查进程状态是否正常。 ps命令查找该进程已经处于Z状态，即僵尸进程。</p>
<p>这种情况下top pidstat之类的工具无法给出更多的信息，此时像第5篇一样，用perf record -d和perf report进行分析，查看app进程调用栈。</p>
<p>看到app确实在通过系统调用sys_read()读取数据，并且从new_sync_read和blkdev_direct_IO看出进程时进行直接读操作，请求直接从磁盘读，没有通过缓存导致iowait升高。</p>
<p>通过层层分析后，root cause是app内部进行了磁盘的直接I/O。然后定位到具体代码位置进行优化即可。</p>
<h4 id="僵尸进程">僵尸进程</h4>
<p>上述优化后iowait显著下降，但是僵尸进程数量仍旧在增加。首先要定位僵尸进程的父进程，通过pstree -aps XXX，打印出该僵尸进程的调用树，发现父进程就是app进程。</p>
<p>查看app代码，看看子进程结束的处理是否正确（是否调用wait()/waitpid(),有没有注册SIGCHILD信号的处理函数等）。</p>
<p><strong>碰到iowait升高时，先用dstat pidstat等工具确认是否存在磁盘I/O问题，再找是哪些进程导致I/O，不能用strace直接分析进程调用时可以通过perf工具分析。</strong></p>
<p><strong>对于僵尸问题，用pstree找到父进程，然后看源码检查子进程结束的处理逻辑即可。</strong></p>
<h3 id="cpu性能指标">CPU性能指标</h3>
<ul>
<li>
<p>CPU使用率</p>
<ul>
<li>用户CPU使用率, 包括用户态(user)和低优先级用户态(nice). 该指标过高说明应用程序比较繁忙.</li>
<li>系统CPU使用率, CPU在内核态运行的时间百分比(不含中断). 该指标高说明内核比较繁忙.</li>
<li>等待I/O的CPU使用率, iowait, 该指标高说明系统与硬件设备I/O交互时间比较长.</li>
<li>软/硬中断CPU使用率, 该指标高说明系统中发生大量中断.</li>
<li>steal CPU / guest CPU, 表示虚拟机占用的CPU百分比.</li>
</ul>
</li>
<li>
<p>平均负载</p>
<p>理想情况下平均负载等于逻辑CPU个数,表示每个CPU都被充分利用. 若大于则说明系统负载较重.</p>
</li>
<li>
<p>进程上下文切换</p>
<p>包括无法获取资源的自愿切换和系统强制调度时的非自愿切换. 上下文切换本身是保证Linux正常运行的一项核心功能. 过多的切换则会将原本运行进程的CPU时间消耗在寄存器,内核占及虚拟内存等数据保存和恢复上</p>
</li>
<li>
<p>CPU缓存命中率</p>
<p>CPU缓存的复用情况,命中率越高性能越好. 其中L1/L2常用在单核,L3则用在多核中</p>
</li>
</ul>
<h3 id="性能工具">性能工具</h3>
<ul>
<li>平均负载案例
<ul>
<li>先用uptime查看系统平均负载</li>
<li>判断负载在升高后再用mpstat和pidstat分别查看每个CPU和每个进程CPU使用情况.找出导致平均负载较高的进程.</li>
</ul>
</li>
<li>上下文切换案例
<ul>
<li>先用vmstat查看系统上下文切换和中断次数</li>
<li>再用pidstat观察进程的自愿和非自愿上下文切换情况</li>
<li>最后通过pidstat观察线程的上下文切换情况</li>
</ul>
</li>
<li>进程CPU使用率高案例
<ul>
<li>先用top查看系统和进程的CPU使用情况,定位到进程</li>
<li>再用perf top观察进程调用链,定位到具体函数</li>
</ul>
</li>
<li>系统CPU使用率高案例
<ul>
<li>先用top查看系统和进程的CPU使用情况,top/pidstat都无法找到CPU使用率高的进程</li>
<li>重新审视top输出</li>
<li>从CPU使用率不高,但是处于Running状态的进程入手</li>
<li>perf record/report发现短时进程导致 (execsnoop工具)</li>
</ul>
</li>
<li>不可中断和僵尸进程案例
<ul>
<li>先用top观察iowait升高,发现大量不可中断和僵尸进程</li>
<li>strace无法跟踪进程系统调用</li>
<li>perf分析调用链发现根源来自磁盘直接I/O</li>
</ul>
</li>
<li>软中断案例
<ul>
<li>top观察系统软中断CPU使用率高</li>
<li>查看/proc/softirqs找到变化速率较快的几种软中断</li>
<li>sar命令发现是网络小包问题</li>
<li>tcpdump找出网络帧的类型和来源, 确定SYN FLOOD攻击导致</li>
</ul>
</li>
</ul>
<p>根据不同的性能指标来找合适的工具:</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-3.png" alt="Linux Performance Tools"></p>
<p>在生产环境中往往开发者没有权限安装新的工具包,只能最大化利用好系统中已经安装好的工具. 因此要了解一些主流工具能够提供哪些指标分析.</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-4.png" alt="Linux Performance Tools"></p>
<p>先运行几个支持指标较多的工具, 如top/vmstat/pidstat,根据它们的输出可以得出是哪种类型的性能问题. 定位到进程后再用strace/perf分析调用情况进一步分析. 如果是软中断导致用/proc/softirqs</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-5.png" alt="Linux Performance Tools"></p>
<h3 id="cpu优化">CPU优化</h3>
<ul>
<li>
<p>应用程序优化</p>
<ul>
<li>编译器优化: 编译阶段开启优化选项, 如gcc -O2</li>
<li>算法优化</li>
<li>异步处理: 避免程序因为等待某个资源而一直阻塞,提升程序的并发处理能力. (将轮询替换为事件通知)</li>
<li>多线程代替多进程: 减少上下文切换成本</li>
<li>善用缓存: 加快程序处理速度</li>
</ul>
</li>
<li>
<p>系统优化</p>
<ul>
<li>CPU绑定: 将进程绑定要1个/多个CPU上,提高CPU缓存命中率,减少CPU调度带来的上下文切换</li>
<li>CPU独占: CPU亲和性机制来分配进程</li>
<li>优先级调整:使用nice适当降低非核心应用的优先级</li>
<li>为进程设置资源显示: cgroups设置使用上限,防止由某个应用自身问题耗尽系统资源</li>
<li>NUMA优化: CPU尽可能访问本地内存</li>
<li>中断负载均衡: irpbalance,将中断处理过程自动负载均衡到各个CPU上</li>
</ul>
</li>
<li>
<p>TPS、QPS、系统吞吐量的区别和理解</p>
<ul>
<li>
<p>QPS (Queries Per Second)每秒查询率,一台服务器每秒能够响应的查询次数.</p>
</li>
<li>
<p>TPS (Transactions Per Second)每秒事务数,软件测试的结果.</p>
<ul>
<li>
<p>用户请求服务器</p>
</li>
<li>
<p>服务器内部处理</p>
</li>
<li>
<p>服务器返回给客户</p>
<p>QPS类似TPS,但是对于一个页面的访问形成一个TPS,但是一次页面请求可能包含多次对服务器的请求,可能计入多次QPS</p>
</li>
</ul>
</li>
<li>
<p>系统吞吐量, 包括几个重要参数:</p>
<ul>
<li>
<p>QPS(TPS)</p>
</li>
<li>
<p>并发数</p>
</li>
<li>
<p>响应时间</p>
<p>QPS(TPS)=并发数/平均相应时间</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="内存">内存</h2>
<h3 id="linux内存是怎么工作的">Linux内存是怎么工作的</h3>
<h4 id="内存映射">内存映射</h4>
<p>大多数计算机用的主存都是动态随机访问内存(DRAM)，只有内核才可以直接访问物理内存。Linux内核给每个进程提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样进程就可以很方便的访问内存(虚拟内存)。</p>
<p>虚拟地址空间的内部分为内核空间和用户空间两部分，不同字长的处理器地址空间的范围不同。32位系统内核空间占用1G，用户空间占3G。 64位系统内核空间和用户空间都是128T，分别占内存空间的最高和最低处，中间部分为未定义。</p>
<p>并不是所有的虚拟内存都会分配物理内存，只有实际使用的才会。分配后的物理内存通过内存映射管理。为了完成内存映射，内核为每个进程都维护了一个页表，记录虚拟地址和物理地址的映射关系。页表实际存储在CPU的内存管理单元MMU中，处理器可以直接通过硬件找出要访问的内存。</p>
<p>当进程访问的虚拟地址在页表中查不到时，系统会产生一个缺页异常，进入内核空间分配物理内存，更新进程页表，再返回用户空间恢复进程的运行。</p>
<p>MMU以页为单位管理内存，页大小4KB。为了解决页表项过多问题Linux提供了<strong>多级页表</strong>和<strong>HugePage</strong>的机制。</p>
<h4 id="虚拟内存空间分布">虚拟内存空间分布</h4>
<p>用户空间内存从低到高是五种不同的内存段：</p>
<ul>
<li><strong>只读段</strong> 代码和常量等</li>
<li><strong>数据段</strong> 全局变量等</li>
<li><strong>堆</strong> 动态分配的内存，从低地址开始向上增长</li>
<li><strong>文件映射</strong> 动态库、共享内存等，从高地址开始向下增长</li>
<li><strong>栈</strong> 包括局部变量和函数调用的上下文等，栈的大小是固定的。一般8MB</li>
</ul>
<h4 id="内存分配与回收">内存分配与回收</h4>
<h5 id="分配">分配</h5>
<p>malloc对应到系统调用上有两种实现方式：</p>
<ul>
<li><strong>brk()</strong> 针对小块内存(&lt;128K)，通过移动堆顶位置来分配。内存释放后不立即归还内存，而是被缓存起来。</li>
<li>**mmap()**针对大块内存(&gt;128K)，直接用内存映射来分配，即在文件映射段找一块空闲内存分配。</li>
</ul>
<p>前者的缓存可以减少缺页异常的发生，提高内存访问效率。但是由于内存没有归还系统，在内存工作繁忙时，频繁的内存分配/释放会造成内存碎片。</p>
<p>后者在释放时直接归还系统，所以每次mmap都会发生缺页异常。在内存工作繁忙时，频繁内存分配会导致大量缺页异常，使内核管理负担增加。</p>
<p>上述两种调用并没有真正分配内存，这些内存只有在首次访问时，才通过缺页异常进入内核中，由内核来分配</p>
<h5 id="回收">回收</h5>
<p>内存紧张时，系统通过以下方式来回收内存：</p>
<ul>
<li>
<p>回收缓存： LRU算法回收最近最少使用的内存页面；</p>
</li>
<li>
<p>回收不常访问内存： 把不常用的内存通过交换分区写入磁盘</p>
</li>
<li>
<p>杀死进程： OOM内核保护机制 （进程消耗内存越大oom_score越大，占用CPU越多oom_score越小，可以通过/proc手动调整oom_adj）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">echo -16 &gt; /proc/<span style="color:#66d9ef">$(</span>pidof XXX<span style="color:#66d9ef">)</span>/oom_adj
</code></pre></div></li>
</ul>
<h4 id="如何查看内存使用情况">如何查看内存使用情况</h4>
<p>free来查看整个系统的内存使用情况</p>
<p>top/ps来查看某个进程的内存使用情况</p>
<ul>
<li><strong>VIRT</strong> 进程的虚拟内存大小</li>
<li><strong>RES</strong> 常驻内存的大小，即进程实际使用的物理内存大小，不包括swap和共享内存</li>
<li><strong>SHR</strong> 共享内存大小，与其他进程共享的内存，加载的动态链接库以及程序代码段</li>
<li><strong>%MEM</strong> 进程使用物理内存占系统总内存的百分比</li>
</ul>
<h3 id="怎样理解内存中的buffer和cache">怎样理解内存中的Buffer和Cache？</h3>
<p><strong>buffer是对磁盘数据的缓存，cache是对文件数据的缓存，它们既会用在读请求也会用在写请求中</strong></p>
<h3 id="如何利用系统缓存优化程序的运行效率">如何利用系统缓存优化程序的运行效率</h3>
<h4 id="缓存命中率">缓存命中率</h4>
<p><strong>缓存命中率</strong>是指直接通过缓存获取数据的请求次数，占所有请求次数的百分比。<strong>命中率越高说明缓存带来的收益越高，应用程序的性能也就越好。</strong></p>
<p>安装bcc包后可以通过cachestat和cachetop来监测缓存的读写命中情况。</p>
<p>安装pcstat后可以查看文件在内存中的缓存大小以及缓存比例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#首先安装Go</span>
export GOPATH<span style="color:#f92672">=</span>~/go
export PATH<span style="color:#f92672">=</span>~/go/bin:$PATH
go get golang.org/x/sys/unix
go ge github.com/tobert/pcstat/pcstat
</code></pre></div><h4 id="dd缓存加速">dd缓存加速</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/sda1 of<span style="color:#f92672">=</span>file bs<span style="color:#f92672">=</span>1M count<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span> <span style="color:#75715e">#生产一个512MB的临时文件</span>
echo <span style="color:#ae81ff">3</span> &gt; /proc/sys/vm/drop_caches <span style="color:#75715e">#清理缓存</span>
pcstat file <span style="color:#75715e">#确定刚才生成文件不在系统缓存中，此时cached和percent都是0</span>
cachetop <span style="color:#ae81ff">5</span>
dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>file of<span style="color:#f92672">=</span>/dev/null bs<span style="color:#f92672">=</span>1M <span style="color:#75715e">#测试文件读取速度</span>
<span style="color:#75715e">#此时文件读取性能为30+MB/s，查看cachetop结果发现并不是所有的读都落在磁盘上，读缓存命中率只有50%。</span>
dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>file of<span style="color:#f92672">=</span>/dev/null bs<span style="color:#f92672">=</span>1M <span style="color:#75715e">#重复上述读文件测试</span>
<span style="color:#75715e">#此时文件读取性能为4+GB/s，读缓存命中率为100%</span>
pcstat file <span style="color:#75715e">#查看文件file的缓存情况，100%全部缓存</span>
</code></pre></div><h4 id="o_direct选项绕过系统缓存">O_DIRECT选项绕过系统缓存</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">cachetop <span style="color:#ae81ff">5</span>
sudo docker run --privileged --name<span style="color:#f92672">=</span>app -itd feisky/app:io-direct
sudo docker logs app <span style="color:#75715e">#确认案例启动成功</span>
<span style="color:#75715e">#实验结果表明每读32MB数据都要花0.9s，且cachetop输出中显示1024次缓存全部命中</span>
</code></pre></div><p>但是凭感觉可知如果缓存命中读速度不应如此慢，读次数时1024，页大小为4K，五秒的时间内读取了1024*4KB数据，即每秒0.8MB，和结果中32MB相差较大。说明该案例没有充分利用缓存，怀疑系统调用设置了直接I/O标志绕过系统缓存。因此接下来观察系统调用.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">strace -p <span style="color:#66d9ef">$(</span>pgrep app<span style="color:#66d9ef">)</span>
<span style="color:#75715e">#strace 结果可以看到openat打开磁盘分区/dev/sdb1，传入参数为O_RDONLY|O_DIRECT</span>
</code></pre></div><p>这就解释了为什么读32MB数据那么慢，直接从磁盘读写肯定远远慢于缓存。找出问题后我们再看案例的源代码发现flags中指定了直接IO标志。删除该选项后重跑，验证性能变化。</p>
<h3 id="内存泄漏如何定位和处理">内存泄漏，如何定位和处理？</h3>
<p>对应用程序来说，动态内存的分配和回收是核心又复杂的一个逻辑功能模块。管理内存的过程中会发生各种各样的“事故”：</p>
<ul>
<li>没正确回收分配的内存，导致了泄漏</li>
<li>访问的是已分配内存边界外的地址，导致程序异常退出</li>
</ul>
<h4 id="内存的分配与回收">内存的分配与回收</h4>
<p>虚拟内存分布从低到高分别是<strong>只读段，数据段，堆，内存映射段，栈</strong>五部分。其中会导致内存泄漏的是：</p>
<ul>
<li>堆： 由应用程序自己来分配和管理，除非程序退出这些堆内存不会被系统自动释放。</li>
<li>内存映射段：包括动态链接库和共享内存，其中共享内存由程序自动分配和管理</li>
</ul>
<p><strong>内存泄漏的危害比较大，这些忘记释放的内存，不仅应用程序自己不能访问，系统也不能把它们再次分配给其他应用。</strong> 内存泄漏不断累积甚至会耗尽系统内存.</p>
<h4 id="如何检测内存泄漏">如何检测内存泄漏</h4>
<p>预先安装systat，docker，bcc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker run --name<span style="color:#f92672">=</span>app -itd feisky/app:mem-leak
sudo docker logs app
vmstat <span style="color:#ae81ff">3</span>
</code></pre></div><p>可以看到free在不断下降，buffer和cache基本保持不变。说明系统的内存一致在升高。但并不能说明存在内存泄漏。此时可以通过memleak工具来跟踪系统或进程的内存分配/释放请求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">/usr/share/bcc/tools/memleak -a -p <span style="color:#66d9ef">$(</span>pidof app<span style="color:#66d9ef">)</span>
</code></pre></div><p>从memleak输出可以看到，应用在不停地分配内存，并且这些分配的地址并没有被回收。通过调用栈看到是fibonacci函数分配的内存没有释放。定位到源码后查看源码来修复增加内存释放函数即可.</p>
<h3 id="为什么系统的swap变高">为什么系统的Swap变高</h3>
<p>系统内存资源紧张时通过内存回收和OOM杀死进程来解决。其中可回收内存包括：</p>
<ul>
<li>缓存/缓冲区，属于可回收资源，在文件管理中通常叫做文件页
<ul>
<li>被应用程序修改过暂时没写入磁盘的数据(脏页)，要先写入磁盘然后才能内存释放
<ul>
<li>在应用程序中通过fsync将脏页同步到磁盘</li>
<li>交给系统，内核线程pdflush负责这些脏页的刷新</li>
</ul>
</li>
</ul>
</li>
<li>内存映射获取的文件映射页，也可以被释放掉，下次访问时从文件重新读取</li>
</ul>
<p>对于程序自动分配的堆内存，也就是我们在内存管理中的匿名页，虽然这些内存不能直接释放，但是Linux提供了Swap机制将不常访问的内存写入到磁盘来释放内存，再次访问时从磁盘读取到内存即可。</p>
<h4 id="swap原理">Swap原理</h4>
<p>Swap本质就是把一块磁盘空间或者一个本地文件当作内存来使用，包括换入和换出两个过程：</p>
<ul>
<li>换出： 将进程暂时不用的内存数据存储到磁盘中，并释放这些内存</li>
<li>换入： 进程再次访问内存时，将它们从磁盘读到内存中</li>
</ul>
<p>Linux如何衡量内存资源是否紧张？</p>
<ul>
<li>
<p><strong>直接内存回收</strong> 新的大块内存分配请求，但剩余内存不足。此时系统会回收一部分内存；</p>
</li>
<li>
<p><strong>kswapd0</strong> 内核线程定期回收内存。为了衡量内存使用情况，定义了pages_min,pages_low,pages_high三个阈值，并根据其来进行内存的回收操作。</p>
<ul>
<li>
<p>剩余内存 &lt; pages_min，进程可用内存耗尽了，只有内核才可以分配内存</p>
</li>
<li>
<p>pages_min &lt; 剩余内存 &lt; pages_low,内存压力较大，kswapd0执行内存回收，直到剩余内存 &gt; pages_high</p>
</li>
<li>
<p>pages_low &lt; 剩余内存 &lt; pages_high，内存有一定压力，但可以满足新内存请求</p>
</li>
<li>
<p>剩余内存 &gt; pages_high，说明剩余内存较多，无内存压力</p>
<p>pages_low = pages_min <em>5 / 4
pages_high = pages_min</em> 3 / 2</p>
</li>
</ul>
</li>
</ul>
<h4 id="numa-与-swap">NUMA 与 SWAP</h4>
<p>很多情况下系统剩余内存较多，但SWAP依旧升高，这是由于处理器的NUMA架构。</p>
<p>在NUMA架构下多个处理器划分到不同的Node，每个Node都拥有自己的本地内存空间。在分析内存的使用时应该针对每个Node单独分析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">numactl --hardware <span style="color:#75715e">#查看处理器在Node的分布情况，以及每个Node的内存使用情况</span>
</code></pre></div><p>内存三个阈值可以通过/proc/zoneinfo来查看，该文件中还包括活跃和非活跃的匿名页/文件页数。</p>
<p>当某个Node内存不足时，系统可以从其他Node寻找空闲资源，也可以从本地内存中回收内存。 通过/proc/sys/vm/zone_raclaim_mode来调整。</p>
<ul>
<li>0表示既可以从其他Node寻找空闲资源，也可以从本地回收内存</li>
<li>1，2，4表示只回收本地内存，2表示可以会回脏数据回收内存，4表示可以用Swap方式回收内存。</li>
</ul>
<h4 id="swappiness">swappiness</h4>
<p>在实际回收过程中Linux根据/proc/sys/vm/swapiness选项来调整使用Swap的积极程度，从0-100，数值越大越积极使用Swap，即更倾向于回收匿名页；数值越小越消极使用Swap，即更倾向于回收文件页。</p>
<p><strong>注意：这只是调整Swap积极程度的权重，即使设置为0，当剩余内存+文件页小于页高阈值时，还是会发生Swap。</strong></p>
<h4 id="swap升高时如何定位分析">Swap升高时如何定位分析</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">free <span style="color:#75715e">#首先通过free查看swap使用情况，若swap=0表示未配置Swap</span>
<span style="color:#75715e">#先创建并开启swap</span>
fallocate -l 8G /mnt/swapfile
chmod <span style="color:#ae81ff">600</span> /mnt/swapfile
mkswap /mnt/swapfile
swapon /mnt/swapfile

free <span style="color:#75715e">#再次执行free确保Swap配置成功</span>

dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/sda1 of<span style="color:#f92672">=</span>/dev/null bs<span style="color:#f92672">=</span>1G count<span style="color:#f92672">=</span><span style="color:#ae81ff">2048</span> <span style="color:#75715e">#模拟大文件读取</span>
sar -r -S <span style="color:#ae81ff">1</span>  <span style="color:#75715e">#查看内存各个指标变化 -r内存 -S swap</span>
<span style="color:#75715e">#根据结果可以看出，%memused在不断增长，剩余内存kbmemfress不断减少，缓冲区kbbuffers不断增大，由此可知剩余内存不断分配给了缓冲区</span>
<span style="color:#75715e">#一段时间之后，剩余内存很小，而缓冲区占用了大部分内存。此时Swap使用之间增大，缓冲区和剩余内存只在小范围波动</span>

停下sar命令
cachetop5 <span style="color:#75715e">#观察缓存</span>
<span style="color:#75715e">#可以看到dd进程读写只有50%的命中率，未命中数为4w+页，说明正式dd进程导致缓冲区使用升高</span>
watch -d grep -A <span style="color:#ae81ff">15</span> ‘Normal’ /proc/zoneinfo <span style="color:#75715e">#观察内存指标变化</span>
<span style="color:#75715e">#发现升级内存在一个小范围不停的波动，低于页低阈值时会突然增大到一个大于页高阈值的值</span>
</code></pre></div><p>说明剩余内存和缓冲区的波动变化正是由于内存回收和缓存再次分配的循环往复。有时候Swap用的多，有时候缓冲区波动更多。此时查看swappiness值为60，是一个相对中和的配置，系统会根据实际运行情况来选去合适的回收类型.</p>
<h3 id="如何快准狠找到系统内存存在的问题">如何“快准狠”找到系统内存存在的问题</h3>
<h4 id="内存性能指标">内存性能指标</h4>
<p><strong>系统内存指标</strong></p>
<ul>
<li>已用内存/剩余内存</li>
<li>共享内存 （tmpfs实现）</li>
<li>可用内存： 包括剩余内存和可回收内存</li>
<li>缓存：磁盘读取文件的页缓存，slab分配器中的可回收部分</li>
<li>缓冲区： 原始磁盘块的临时存储，缓存将要写入磁盘的数据</li>
</ul>
<p><strong>进程内存指标</strong></p>
<ul>
<li>虚拟内存： 5大部分</li>
<li>常驻内存： 进程实际使用的物理内存，不包括Swap和共享内存</li>
<li>共享内存： 与其他进程共享的内存，以及动态链接库和程序的代码段</li>
<li>Swap内存： 通过Swap换出到磁盘的内存</li>
</ul>
<p><strong>缺页异常</strong></p>
<ul>
<li>可以直接从物理内存中分配，次缺页异常</li>
<li>需要磁盘IO介入(如Swap)，主缺页异常。 此时内存访问会慢很多</li>
</ul>
<h4 id="内存性能工具">内存性能工具</h4>
<p>根据不同的性能指标来找合适的工具:</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-6.png" alt="Linux Performance Tools"></p>
<p>内存分析工具包含的性能指标:</p>
<p><img src="https://www.kad8.com/imgs/post/linux-performance-optimization-7.png" alt="Linux Performance Tools"></p>
<h4 id="如何迅速分析内存的性能瓶颈">如何迅速分析内存的性能瓶颈</h4>
<p>通常先运行几个覆盖面比较大的性能工具，如free，top，vmstat，pidstat等</p>
<ul>
<li>先用free和top查看系统整体内存使用情况</li>
<li>再用vmstat和pidstat，查看一段时间的趋势，从而判断内存问题的类型</li>
<li>最后进行详细分析，比如内存分配分析，缓存/缓冲区分析，具体进程的内存使用分析等</li>
</ul>
<p>常见的优化思路：</p>
<ul>
<li>最好禁止Swap，若必须开启则尽量降低swappiness的值</li>
<li>减少内存的动态分配，如可以用内存池，HugePage等</li>
<li>尽量使用缓存和缓冲区来访问数据。如用堆栈明确声明内存空间来存储需要缓存的数据，或者用Redis外部缓存组件来优化数据的访问</li>
<li>cgroups等方式来限制进程的内存使用情况，确保系统内存不被异常进程耗尽</li>
<li>/proc/pid/oom_adj调整核心应用的oom_score，保证即使内存紧张核心应用也不会被OOM杀死</li>
</ul>
<h5 id="vmstat使用详解">vmstat使用详解</h5>
<p>vmstat命令是最常见的Linux/Unix监控工具，可以展现给定时间间隔的服务器的状态值,包括服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况。可以看到整个机器的CPU,内存,IO的使用情况，而不是单单看到各个进程的CPU使用率和内存使用率(使用场景不一样)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">vmstat <span style="color:#ae81ff">2</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1379064</span> <span style="color:#ae81ff">282244</span> <span style="color:#ae81ff">11537528</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">104</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">97</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1372716</span> <span style="color:#ae81ff">282244</span> <span style="color:#ae81ff">11537544</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">4893</span> <span style="color:#ae81ff">8947</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1373404</span> <span style="color:#ae81ff">282248</span> <span style="color:#ae81ff">11537544</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">96</span> <span style="color:#ae81ff">5105</span> <span style="color:#ae81ff">9278</span>  <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1374168</span> <span style="color:#ae81ff">282248</span> <span style="color:#ae81ff">11537556</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">5001</span> <span style="color:#ae81ff">9208</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">99</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1376948</span> <span style="color:#ae81ff">282248</span> <span style="color:#ae81ff">11537564</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">5176</span> <span style="color:#ae81ff">9388</span>  <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1379356</span> <span style="color:#ae81ff">282256</span> <span style="color:#ae81ff">11537580</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">202</span> <span style="color:#ae81ff">5474</span> <span style="color:#ae81ff">9519</span>  <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">98</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1368376</span> <span style="color:#ae81ff">282256</span> <span style="color:#ae81ff">11543696</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">5894</span> <span style="color:#ae81ff">8940</span> <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">88</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1371936</span> <span style="color:#ae81ff">282256</span> <span style="color:#ae81ff">11539240</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">10554</span> <span style="color:#ae81ff">6176</span> <span style="color:#ae81ff">9481</span> <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">85</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1366184</span> <span style="color:#ae81ff">282260</span> <span style="color:#ae81ff">11542292</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">7456</span> <span style="color:#ae81ff">6102</span> <span style="color:#ae81ff">9983</span>  <span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">91</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1353040</span> <span style="color:#ae81ff">282260</span> <span style="color:#ae81ff">11556176</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">16924</span> <span style="color:#ae81ff">7233</span> <span style="color:#ae81ff">9578</span> <span style="color:#ae81ff">18</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1359432</span> <span style="color:#ae81ff">282260</span> <span style="color:#ae81ff">11549124</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">12576</span> <span style="color:#ae81ff">5495</span> <span style="color:#ae81ff">9271</span>  <span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">92</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1361744</span> <span style="color:#ae81ff">282264</span> <span style="color:#ae81ff">11549132</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">58</span> <span style="color:#ae81ff">8606</span> <span style="color:#ae81ff">15079</span>  <span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">95</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1367120</span> <span style="color:#ae81ff">282264</span> <span style="color:#ae81ff">11549140</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">5716</span> <span style="color:#ae81ff">9205</span>  <span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">92</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1346580</span> <span style="color:#ae81ff">282264</span> <span style="color:#ae81ff">11562644</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">6416</span> <span style="color:#ae81ff">9944</span> <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">88</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1359164</span> <span style="color:#ae81ff">282264</span> <span style="color:#ae81ff">11550108</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">2922</span> <span style="color:#ae81ff">4941</span> <span style="color:#ae81ff">8969</span>  <span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">97</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1353992</span> <span style="color:#ae81ff">282264</span> <span style="color:#ae81ff">11557044</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">6023</span> <span style="color:#ae81ff">8917</span> <span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">84</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>

<span style="color:#75715e"># 结果说明</span>
- r 表示运行队列<span style="color:#f92672">(</span>就是说多少个进程真的分配到CPU<span style="color:#f92672">)</span>，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。

- b 表示阻塞的进程,这个不多说，进程阻塞，大家懂的。

- swpd 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。

- free   空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。

- buff   Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M

- cache cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M<span style="color:#f92672">(</span>这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。<span style="color:#f92672">)</span>

- si  每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。

- so  每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。

- bi  块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据<span style="color:#f92672">(</span>2-3T<span style="color:#f92672">)</span>的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒

- bo 块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。

- in 每秒CPU的中断次数，包括时间中断

- cs 每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。

- us 用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80<span style="color:#f92672">(</span>机器在做压力测试，性能表现不佳<span style="color:#f92672">)</span>。

- sy 系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。

- id 空闲CPU时间，一般来说，id + us + sy <span style="color:#f92672">=</span> 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。

- wt 等待IO CPU时间
</code></pre></div><h5 id="pidstat-使用详解">pidstat 使用详解</h5>
<p>pidstat主要用于监控全部或指定进程占用系统资源的情况,如CPU,内存、设备IO、任务切换、线程等。</p>
<p>使用方法：</p>
<ul>
<li>pidstat –d interval times 统计各个进程的IO使用情况</li>
<li>pidstat –u interval times 统计各个进程的CPU统计信息</li>
<li>pidstat –r interval times 统计各个进程的内存使用信息</li>
<li>pidstat -w interval times 统计各个进程的上下文切换</li>
<li>p PID 指定PID</li>
</ul>
<p>1、统计IO使用情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">pidstat -d <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">10</span>

03:02:02 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
03:02:03 PM     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">816</span>      0.00    918.81      0.00  jbd2/vda1-8
03:02:03 PM     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">1007</span>      0.00      3.96      0.00  AliYunDun
03:02:03 PM   <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">7326</span>      0.00   1904.95    918.81  java
03:02:03 PM   <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">8539</span>      0.00      3.96      0.00  java
03:02:03 PM     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">16066</span>      0.00     35.64      0.00  cmagent

03:02:03 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
03:02:04 PM     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">816</span>      0.00   1924.00      0.00  jbd2/vda1-8
03:02:04 PM   <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">7326</span>      0.00  11156.00   1888.00  java
03:02:04 PM   <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">8539</span>      0.00      4.00      0.00  java
</code></pre></div><ul>
<li>UID</li>
<li>PID</li>
<li>kB_rd/s: 每秒进程从磁盘读取的数据量 KB 单位 read from disk each second KB</li>
<li>kB_wr/s: 每秒进程向磁盘写的数据量 KB 单位 write to disk each second KB</li>
<li>kB_ccwr/s: 每秒进程向磁盘写入，但是被取消的数据量，This may occur when the task truncates some dirty pagecache.</li>
<li>iodelay: Block I/O delay, measured in clock ticks</li>
<li>Command: 进程名 task name</li>
</ul>
<p>2、统计CPU使用情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 统计CPU</span>
pidstat -u <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">10</span>
03:03:33 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
03:03:34 PM     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">2321</span>    3.96    0.00    0.00    3.96     <span style="color:#ae81ff">0</span>  ansible
03:03:34 PM     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">7110</span>    0.00    0.99    0.00    0.99     <span style="color:#ae81ff">4</span>  pidstat
03:03:34 PM   <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">8539</span>    0.99    0.00    0.00    0.99     <span style="color:#ae81ff">5</span>  java
03:03:34 PM   <span style="color:#ae81ff">984</span>     <span style="color:#ae81ff">15517</span>    0.99    0.00    0.00    0.99     <span style="color:#ae81ff">5</span>  java
03:03:34 PM     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">24406</span>    0.99    0.00    0.00    0.99     <span style="color:#ae81ff">5</span>  java
03:03:34 PM     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">32158</span>    3.96    0.00    0.00    3.96     <span style="color:#ae81ff">2</span>  ansible
</code></pre></div><ul>
<li>UID</li>
<li>PID</li>
<li>%usr: 进程在用户空间占用 cpu 的百分比</li>
<li>%system: 进程在内核空间占用 CPU 百分比</li>
<li>%guest: 进程在虚拟机占用 CPU 百分比</li>
<li>%wait: 进程等待运行的百分比</li>
<li>%CPU: 进程占用 CPU 百分比</li>
<li>CPU: 处理进程的 CPU 编号</li>
<li>Command: 进程名</li>
</ul>
<p>3、统计内存使用情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 统计内存</span>
pidstat -r <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">10</span>
Average:      UID       PID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command
Average:        <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">1</span>      0.20      0.00  <span style="color:#ae81ff">191256</span>   <span style="color:#ae81ff">3064</span>   0.01  systemd
Average:        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">1007</span>      1.30      0.00  <span style="color:#ae81ff">143256</span>  <span style="color:#ae81ff">22720</span>   0.07  AliYunDun
Average:        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">6642</span>      0.10      0.00 <span style="color:#ae81ff">6301904</span> <span style="color:#ae81ff">107680</span>   0.33  java
Average:      <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">7326</span>     10.89      0.00 <span style="color:#ae81ff">13468904</span> <span style="color:#ae81ff">8395848</span>  26.04  java
Average:        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">7795</span>    348.15      0.00  <span style="color:#ae81ff">108376</span>   <span style="color:#ae81ff">1233</span>   0.00  pidstat
Average:      <span style="color:#ae81ff">997</span>      <span style="color:#ae81ff">8539</span>      0.50      0.00 <span style="color:#ae81ff">8242256</span> <span style="color:#ae81ff">2062228</span>   6.40  java
Average:      <span style="color:#ae81ff">987</span>      <span style="color:#ae81ff">9518</span>      0.20      0.00 <span style="color:#ae81ff">6300944</span> <span style="color:#ae81ff">1242924</span>   3.85  java
Average:        <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">10280</span>      3.70      0.00  <span style="color:#ae81ff">807372</span>   <span style="color:#ae81ff">8344</span>   0.03  aliyun-service
Average:      <span style="color:#ae81ff">984</span>     <span style="color:#ae81ff">15517</span>      0.40      0.00 <span style="color:#ae81ff">6386464</span> <span style="color:#ae81ff">1464572</span>   4.54  java
Average:        <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">16066</span>    236.46      0.00 <span style="color:#ae81ff">2678332</span>  <span style="color:#ae81ff">71020</span>   0.22  cmagent
Average:      <span style="color:#ae81ff">995</span>     <span style="color:#ae81ff">20955</span>      0.30      0.00 <span style="color:#ae81ff">6312520</span> <span style="color:#ae81ff">1408040</span>   4.37  java
Average:      <span style="color:#ae81ff">995</span>     <span style="color:#ae81ff">20956</span>      0.20      0.00 <span style="color:#ae81ff">6093764</span> <span style="color:#ae81ff">1505028</span>   4.67  java
Average:        <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">23936</span>      0.10      0.00 <span style="color:#ae81ff">5302416</span> <span style="color:#ae81ff">110804</span>   0.34  java
Average:        <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">24406</span>      0.70      0.00 <span style="color:#ae81ff">10211672</span> <span style="color:#ae81ff">2361304</span>   7.32  java
Average:        <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">26870</span>      1.40      0.00 <span style="color:#ae81ff">1470212</span>  <span style="color:#ae81ff">36084</span>   0.11  promtail
</code></pre></div><ul>
<li>UID</li>
<li>PID</li>
<li>Minflt/s : 每秒次缺页错误次数 （minor page faults），虚拟内存地址映射成物理内存地址产生的 page fault 次数</li>
<li>Majflt/s : 每秒主缺页错误次数 (major page faults), 虚拟内存地址映射成物理内存地址时，相应 page 在 swap 中</li>
<li>VSZ virtual memory usage : 该进程使用的虚拟内存 KB 单位</li>
<li>RSS : 该进程使用的物理内存 KB 单位</li>
<li>%MEM : 内存使用率</li>
<li>Command : 该进程的命令 task name</li>
</ul>
<p>4、查看具体进程使用情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">pidstat -T ALL -r -p <span style="color:#ae81ff">20955</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">10</span>
03:12:16 PM   UID       PID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command
03:12:17 PM   <span style="color:#ae81ff">995</span>     <span style="color:#ae81ff">20955</span>      0.00      0.00 <span style="color:#ae81ff">6312520</span> <span style="color:#ae81ff">1408040</span>   4.37  java

03:12:16 PM   UID       PID minflt-nr majflt-nr  Command
03:12:17 PM   <span style="color:#ae81ff">995</span>     <span style="color:#ae81ff">20955</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>  java
</code></pre></div>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1543398821442998"
     crossorigin="anonymous"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:970px;height:90px"
     data-ad-client="ca-pub-1543398821442998"
     data-ad-slot="4140563281"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



    </div>
    <footer class="post-footer">
      

<div class="post-tags">
  
    <a href="/tags/linux">
    linux
  </a>
    <a href="/tags/performance">
    performance
  </a>
</div>

<div class="addthis_inline_share_toolbox" style="text-align: center;"></div>
<hr/>

<div class="reward-container">
  <div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div>
  <button>赞赏</button>
  <div class="post-reward">
    <div class="post-reward-item">
      <img src="/imgs/ali-pay.png" alt="VxWorks OS - 支付宝">
      <span>支付宝</span>
    </div>
    <div class="post-reward-item">
      <img src="/imgs/wechat-pay.png" alt="VxWorks OS - 微信">
      <span>微信</span>
    </div>
  </div>
</div>


<div class="post-copyright">
  <img src="/imgs/cc/cc.svg" width="75" height="75" align="right" />
  <ul>
    <li class="post-copyright-title">
      <strong>文章标题：</strong>
      Linux性能优化
    </li>
    <li class="post-copyright-author">
      <strong>本文作者： </strong>
      VxWorks OS
    </li>
    <li class="post-copyright-link"> 
      <strong>本文链接：</strong>
       <a id="post-cr-link" href="https://www.kontronn.com/post/linux/linux-performance-optimization.html" title="Linux性能优化">https://www.kontronn.com/post/linux/linux-performance-optimization.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target='_blank' href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh'>BY-NC-SA</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</div>

  <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>
  <div class="social-list">
    
    <div class="social-item">
        <a target="_blank" class="social-link" href="/imgs/wechat_channel.jpg">
          <span class="icon">
            <i class="fab fa-weixin"></i>
          </span>
          <span class="label">WeChat</span>
        </a>
      </div>
  </div>
</div>
<div class="post-nav">
  <div class="post-nav-next post-nav-item">
    <a href="/post/hardware/terminology-of-PCB-circuit-design-and-fabrication.html" rel="next" title="PCB线路设计制作术语">
      <i class="fa fa-chevron-left"></i> PCB线路设计制作术语
    </a>
  </div>
  <div class="post-nav-prev post-nav-item">
    <a href="/post/datacenter/a-detailed-explanation-of-ipv4-and-ipv6-protocols.html" rel="prev" title="一文详解IPv4与IPv6协议">
      一文详解IPv4与IPv6协议
      <i class="fa fa-chevron-right"></i>
    </a>
  </div>
</div>

    </footer>
  </article>
</div>
<div id="comments" class="post-comments">
  <div class="comment-head">
    <div class="comment-headline">
      <i class="fas fa-comments fa-fw"></i>
      <span>评论交流</span>
    </div>
    <div class="comment-switch">
      <span class="first-comment">Giscus</span>
      <span class="switch-btn "></span>
      <span class="second-comment">Waline</span>
    </div>
  </div>
  <div class="comment-wrap">
  
    <div><div class="comment-loading">
  <i class="fa fa-sync fa-spin"></i>
</div><div class="giscus-container"></div>
    </div>
    <div><div class="comment-loading">
  <i class="fa fa-sync fa-spin"></i>
</div><div class="waline-container"></div>
    </div>
  </div>
</div>

    </div>
  </main>
  <footer class="footer">
    <div class="footer-inner">

<div class="copyright">
  &copy;
  <span itemprop="copyrightYear">
    2010 - 2024
  </span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VxWorks OS</span>
</div>


    </div>
  </footer> 
  
  <script type="text/javascript" src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" defer></script>

<script class="next-config" data-name="main" type="application/json">{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://www.kontronn.com","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"unpkg","router":"https://unpkg.com"},"version":"4.3.1","waline":{"cfg":{"emoji":false,"imguploader":false,"pageview":"#waline-pageview-count","placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.11.3"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.11.3"}}}</script>







<script type="text/javascript" src="/js/main.min.7e59cf1a98d842830d8a6f149f78fbbcf9e795b7a9eb76feb34b48c9bf1554d7.js" defer></script>











</body>

</html>